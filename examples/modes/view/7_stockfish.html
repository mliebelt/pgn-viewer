<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Some Games to Edit</title>
    <script src="/lib/dist.js" type="text/javascript"></script>

</head>
<body class='merida brown'>
<h3>Commented games</h3>

<h5>Viewing a game</h5>

<div id="board" style="width: 800px;"></div>

<script src="../../stockfish-lib/stockfish.js"></script>
<script>
    const NO_EMBEDDED_NNUE = window.location.search.match("no-embedded-nnue");

    const $ = (...args) => document.querySelector(...args);

    const formatMB = (n) => {
        return (n ? (n / 1e6).toPrecision(3) : "?") + "MB";
    };

    const isSupported = () => {
        if (typeof WebAssembly !== "object") return false;
        const source = Uint8Array.from([
            0, 97, 115, 109, 1, 0, 0, 0, 1, 5, 1, 96, 0, 1, 123, 3, 2, 1, 0, 7, 8,
            1, 4, 116, 101, 115, 116, 0, 0, 10, 15, 1, 13, 0, 65, 0, 253, 17, 65, 0,
            253, 17, 253, 186, 1, 11,
        ]);
        if (
            typeof WebAssembly.validate !== "function" ||
            !WebAssembly.validate(source)
        )
            return false;
        if (typeof Atomics !== "object") return false;
        if (typeof SharedArrayBuffer !== "function") return false;
        return true;
    };

    const RequestProgress = ({ attrs: { url, onFinishDownload } }) => {
        let state = "INIT"; // 'LOADING', 'DONE', 'FAILED'
        let loaded = 0;
        let total = 0;

        const oninit = () => {
            state = "LOADING";
            m.request({
                url: url,
                method: "GET",
                responseType: "arraybuffer",
                headers: { Accept: "*/*" },
                config: (xhr) => {
                    xhr.onprogress = (e) => {
                        // TODO:
                        // When gzip compressed, the value of "loaded/total" gets messed up.
                        // On Chrome, "loaded" is the value after decompression, but on the other hand,
                        // On Firefox, "loaded" is the value before decompression.
                        loaded = e.loaded;
                        total =
                            e.total ||
                            Number(
                                e.target.getResponseHeader("x-decompressed-content-length")
                            );
                        m.redraw();
                    };
                },
            }).then(
                (response) => {
                    state = "DONE";
                    onFinishDownload(response);
                },
                (e) => {
                    console.error(e);
                    state = "FAILED";
                    onFinishDownload(null);
                }
            );
        };

        const view = () => {
            const fraction =
                total == -1 ? `?MB/?MB` : `${formatMB(loaded)}/${formatMB(total)}`;
            return m("span", [
                `${fraction} [${state}] `,
                m(
                    "span",
                    {
                        style: "cursor: pointer;",
                        onclick: () =>
                            window.alert(
                                "On some browsers, download size might look contradicted due to file compression."
                            ),
                    },
                    "[?]"
                ),
            ]);
        };

        return { oninit, view };
    };
    const loadStockfish = async (params) => {
        return await Stockfish(params);
    };

    const onFinishDownload = (data) => {
        if (!data) {
            stockfish_state = "FAILED";
            m.redraw();
            return;
        }

        loadStockfish({ wasmBinary: data })
            .then((_stockfish) => {
                stockfish = _stockfish;
                stockfish_state = "READY";
                stockfish.addMessageListener((line) => {
                    output += line + "\n";
                    m.redraw();
                });
            })
            .catch((e) => {
                stockfish_state = "FAILED";
                throw e;
            })
            .finally(() => m.redraw());
    };

    const onSelectNnueFile = async (e) => {
        const selected = e.currentTarget.files[0];
        if (selected) {
            //
            // TODO:
            // On Archlinux Chromium 92.0.4515.107, most of times this code fails with the error saying:
            //   TypeError: Failed to execute 'decode' on 'TextDecoder': The provided ArrayBufferView value must not be shared.
            // On the other hand, either Chrome with the same version or Firefox never fail.
            //
            const FS = stockfish.FS;
            const buffer = await selected.arrayBuffer();
            const array = new Uint8Array(buffer);
            const filename = "/" + selected.name;
            FS.writeFile(filename, array);
            stockfish.postMessage(`setoption name EvalFile value ${filename}`);
            stockfish.postMessage(`eval`);
        }
    };

    const oninit = () => {
        stockfish_state = "LOADING";
    };


    var pgn ="[Event \"Rosenwald Memorial Tournament\"]" +
            "[Site \"New York, New York USA\"]" +
            "[Date \"1956.10.17\"]" +
            "[White \"Byrne, Donald\"]" +
            "[Black \"Fischer, Bobby\"]" +
            "[Result \"0-1\"]" +
            "[ECO \"D97\"]" +
            "{This chess game was nicknamed \"The Game of the Century\" by Hans Kmoch in \"Chess Review\". It was played between chessmaster Donald Byrne and 13-year old Bobby Fischer in the Rosenwald Memorial Tournament in New York on October 17, 1956. The text of this annotation was written by David A. Wheeler, based on a number of sources (see references, below) and his own study of the game.  Donald Byrne (1930-1976) had already obtained first place in the 1953 US Open Championship, and would represent the United States in three Olympiads (1962, 1964, and 1968). Robert \"Bobby\" Fischer (1943-) eventually became world champion. In this game, Fischer (playing black) is amazingly brilliant, with such beautiful play that it was called the \"Game of the Century\". Byrne (playing white), after a standard opening, makes a minor mistake on move 11, moving the same piece twice (wasting time). Fischer pounces, with strong sacrificial play, culminating in an incredible queen sacrifice on move 17.  Byrne captures the queen, but Fischer more than compensates by taking many other pieces. The ending is an excellent demonstration of pieces working together to achieve a checkmate.} 1. Nf3 {This is the \"Reti\" opening,  a noncomittal move that can easily transpose into a number of other different openings.} Nf6 2. c4 g6 3. Nc3 Bg7 {Fischer has opted for a defense based on \"hypermodern\" principles: he's inviting Byrne to establish a classical pawn stronghold in the center, which Fischer hopes to undermine and transform into a target. Fischer has fianchettoed his bishop, so it can attack the a1-h8 diagonal including its center squares.} 4. d4 O-O {Fischer castles, concentrating on protecting his king immediately.} 5. Bf4 d5 6. Qb3 dxc4 7.  Qxc4 c6 8. e4 Nbd7 9. Rd1 Nb6 10. Qc5 Bg4 {At this point, Byrne's pieces are more developed, and he controls the center squares. However, Fischer's king is well-protected, while Byrne's king is not.} 11. Bg5$2 {Here Byrne makes a mistake - he moves the same piece twice, losing time, instead of developing in some way. Both Burgess, Nunn and Emms and Wade and O'Connell suggest 11.  Be2; this would protect the King and enable a later kingside castle.}  (11.  Be2 {For example, the game Flear-Morris, Dubling 1991, continued in this way} Nfd7 12. Qa3 Bxf3 13. Bxf3 e5 14. dxe5 Qe8 15. Be2 Nxe5 16. O-O$16) 11... Na4$3 {Here Fischer cleverly offers up his Knight, but if Byrne takes it with Nxa4 Fischer will play Nxe4, and Byrne then suddenly has some terrible choices: } 12. Qa3 (12. Nxa4 Nxe4 13. Qxe7 (13. Bxe7 Nxc5 14. Bxd8 Nxa4 15. Bg5 Bxf3 16.  gxf3 Nxb2 {gives Fischer an extra pawn and ruin's Byrne's pawn structure.}) ( 13. Qc1 Qa5+ 14. Nc3 Bxf3 15. gxf3 Nxg5 {gives Fischer back his piece and a better position.}) 13... Qa5+ 14. b4 Qxa4 15. Qxe4 Rfe8 16. Be7 Bxf3 17. gxf3 Bf8 {produces a terrible pin.}) 12... Nxc3 13. bxc3 Nxe4$1 {Byrne declined to take the knight on move 12, so Fischer tries again by offering material to Byrne, in exchange for a much better position that is especially dangerous to white: an open e-file, with white's king poorly protected.} 14. Bxe7 {Byrne wisely decides to decline the offered material.} Qb6 15. Bc4 Nxc3$1 16. Bc5 Rfe8+ 17. Kf1 Be6$3 {This is a very clever move by Fischer; this is the move that made this game famous. Instead of trying to protect his queen, Fischer viciously counter-attacks using his bishop and sacrifices his queen. Byrne cannot simply take the bishop, because that will lead to checkmate.} 18. Bxb6 { Byrne takes Fischer's queen, as Fischer offered.} (18. Bxe6 Qb5+ 19. Kg1 Ne2+ 20. Kf1 Ng3+ 21. Kg1 Qf1+ 22. Rxf1 Ne2#) 18... Bxc4+ {Fischer now begins a series of discovered checks, picking up material.} 19. Kg1 Ne2+ 20. Kf1 Nxd4+ 21. Kg1 Ne2+ 22. Kf1 Nc3+ 23. Kg1 axb6 {This move by Fischer takes time out to capture a piece, but it doesn't waste time because it also threatens Byrne's queen. Byrne's queen cannot take the knight on c3, because it's protected by Fischer's bishop on g7.} 24. Qb4 Ra4 {Fischer uses his pieces together nicely in concert; the knight on c3 protects the rook on a4, which in turn protects the bishop on c4. This forces Byrne's queen away.} 25. Qxb6 {Byrne's queen picks up a pawn, but it's now poorly placed.} Nxd1 {Fischer has taken a rook, 2 bishops, and a pawn as compensation for his queen; in short, Fischer has gained significantly more material than he's lost. In addition, Byrne's remaining rook is stuck on h1 and it will take precious time to free it, giving Fischer opportunity to set up another offensive. Byrne has the only remaining queen, but this will not be enough.} 26. h3 Rxa2 27. Kh2 Nxf2 28. Re1 Rxe1 29. Qd8+ Bf8 30. Nxe1 Bd5 31. Nf3 Ne4 32. Qb8 b5 33. h4 h5 34. Ne5 Kg7 { Fischer breaks the pin, allowing the bishop to attack as well.} 35. Kg1 Bc5+ { Now Fischer \"peels away\" the white king from his last defender, and begins a series of checks that culminate in checkmate. This series of moves is extremely interesting in the way Fischer shows how to use various pieces together to force a checkmate.} 36. Kf1 Ng3+ {Adjacent bishops can, without opposition, simply move next to each other to force the king along. However, Fischer can't do this here by simply moving his light-square bishop to c4, because Byrne's knight protects c4. However, the knight does the job, forcing Byrne's king along.} 37. Ke1 Bb4+ 38. Kd1 Bb3+ 39. Kc1 Ne2+ 40. Kb1 Nc3+ 41.  Kc1 Rc2#";

    pgnv = PGNV.pgnView("board", {locale: 'en', pgn: pgn, layout: 'left', boardSize: '400px', headers: true});

</script>
</body>